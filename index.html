<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Planner</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“š</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* THEME & COLOR SYSTEM */
        :root {
            --bg-primary: #f4f5f7; --bg-secondary: #ffffff; --bg-tertiary: #e5e7eb;
            --text-primary: #111827; --text-secondary: #6b7280;
            --border-primary: #d1d5db; --border-secondary: #e5e7eb;
            --accent-danger: #ef4444; --text-on-accent: #ffffff;
        }
        html[data-theme="dark"] {
            --bg-primary: #111111; --bg-secondary: #181818; --bg-tertiary: #282828;
            --text-primary: #f5f5f5; --text-secondary: #a3a3a3;
            --border-primary: #3a3a3a; --border-secondary: #2d2d2d;
        }
        html[data-accent="green"] { --accent-primary: #22c55e; --accent-hover: #16a34a; }
        html[data-accent="blue"] { --accent-primary: #3b82f6; --accent-hover: #2563eb; }
        html[data-accent="purple"] { --accent-primary: #a855f7; --accent-hover: #9333ea; }
        html[data-accent="red"] { --accent-primary: #ef4444; --accent-hover: #dc2626; }
        html[data-accent="green"][data-theme="dark"] { --accent-translucent: rgba(34, 197, 94, 0.3); }
        html[data-accent="blue"][data-theme="dark"] { --accent-translucent: rgba(59, 130, 246, 0.3); }
        html[data-accent="purple"][data-theme="dark"] { --accent-translucent: rgba(168, 85, 247, 0.3); }
        html[data-accent="red"][data-theme="dark"] { --accent-translucent: rgba(239, 68, 68, 0.3); }
        html[data-accent="green"][data-theme="light"] { --accent-translucent: rgba(34, 197, 94, 0.2); }
        html[data-accent="blue"][data-theme="light"] { --accent-translucent: rgba(59, 130, 246, 0.2); }
        html[data-accent="purple"][data-theme="light"] { --accent-translucent: rgba(168, 85, 247, 0.2); }
        html[data-accent="red"][data-theme="light"] { --accent-translucent: rgba(239, 68, 68, 0.2); }

        /* BASE & COMPONENT STYLES */
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-primary);
            color: var(--text-primary); transition: background-color 0.2s, color 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .bg-main { background-color: var(--bg-secondary); }
        .text-main { color: var(--text-primary); }
        .text-subtle { color: var(--text-secondary); }
        .bg-tertiary { background-color: var(--bg-tertiary); }
        .border-main { border-color: var(--border-primary); }
        .border-secondary { border-color: var(--border-secondary); }
        /* MODIFICATION: Reduced horizontal padding for better phone alignment. */
        .btn { padding: 0.5rem 1.4rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s, box-shadow 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .btn-primary { background-color: var(--accent-primary); color: var(--text-on-accent); }
        .btn-primary:hover { background-color: var(--accent-hover); }
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background-color: var(--border-primary); }
        .input-main { background-color: var(--bg-tertiary); border: 1px solid var(--border-primary); color: var(--text-primary); border-radius: 0.5rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .input-main:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px var(--accent-translucent); }
        #sidebar { transition: transform 0.3s ease-in-out; transform: translateX(-100%); }
        #sidebar.open { transform: translateX(0); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; background-color: rgba(0,0,0,0.5); }
        .custom-checkbox { border: 2px solid var(--border-primary); transition: all 0.2s; }
        .custom-checkbox.completed { background-color: var(--accent-primary); border-color: var(--accent-primary); }
        .custom-checkbox.completed::after {
            content: 'âœ“'; color: white; display: flex; font-weight: bold; align-items: center;
            justify-content: center; font-size: 1em; line-height: 1; height: 100%;
        }
        .subject-label.completed, .subtask-label.completed { text-decoration: line-through; color: var(--text-secondary); }
        .drag-handle { cursor: grab; }
        .dragging { opacity: 0.5; background-color: var(--bg-tertiary); }
        .drag-over { border-top: 2px solid var(--accent-primary); }
        .progress-circle-bg { stroke: var(--border-primary); }
        .progress-circle-fg { stroke: var(--accent-primary); stroke-linecap: round; transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 0.5s ease; }
        .status-btn { padding: 0.2rem 0.6rem; border-radius: 9999px; font-weight: 600; font-size: 0.7rem; white-space: nowrap; }
        .status-none { background-color: rgba(107, 114, 128, 0.1); color: #6b7280; }
        .status-lecture { background-color: rgba(59, 130, 246, 0.1); color: #3b82f6; }
        .status-revision { background-color: rgba(168, 85, 247, 0.1); color: #a855f7; }
        .status-practice { background-color: rgba(249, 115, 22, 0.1); color: #f97316; }
        .status-test { background-color: rgba(239, 68, 68, 0.1); color: #ef4444; }
        #subject-count-options input[type="radio"]:checked + label {
            background-color: var(--accent-primary);
            color: var(--text-on-accent);
            border-color: var(--accent-primary);
        }
    </style>
</head>

<body class="transition-colors duration-300">
    <div id="sidebar-overlay" data-action="toggleSidebar" class="fixed inset-0 z-40 hidden opacity-0"></div>
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-main shadow-xl p-4 z-50 border-r border-secondary">
        <h2 class="text-xl font-bold mb-6 text-main">Menu</h2>
        <nav><ul>
            <li><button data-action="openModal" data-modal="manage-subjects-modal" class="w-full text-left py-2 px-3 rounded-md hover:bg-tertiary font-semibold transition-colors text-main">Manage Subjects</button></li>
            <li><button data-action="openModal" data-modal="theme-modal" class="w-full text-left py-2 px-3 rounded-md hover:bg-tertiary font-semibold transition-colors text-main">Customize Theme</button></li>
        </ul></nav>
    </aside>
    <main class="flex items-start justify-center min-h-screen p-2 sm:p-4">
        <div class="w-full max-w-3xl bg-main rounded-2xl shadow-lg p-4 sm:p-6 border border-secondary">
            <header class="flex items-center justify-between mb-4 flex-wrap gap-y-4">
                <div class="flex items-center space-x-3">
                    <button data-action="toggleSidebar" class="p-2 rounded-full hover:bg-tertiary transition-colors">
                        <svg class="w-6 h-6 text-subtle" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <div>
                        <h1 id="today-date" class="text-xl font-bold text-main"></h1>
                        <p id="today-day" class="text-sm text-subtle font-medium"></p>
                    </div>
                </div>
                <div class="flex items-center space-x-2"> <!-- MODIFICATION: Reduced space between buttons -->
                    <div id="progress-summary" class="flex items-center space-x-2 text-md font-semibold text-main"></div>
                    <button data-action="openModal" data-modal="edit-subjects-modal" class="btn btn-secondary text-sm">Edit</button>
                    <button data-action="openModal" data-modal="randomize-modal" class="btn btn-primary text-sm">Randomize</button>
                </div>
            </header>
            <section id="session-timer-container" class="text-center mb-6 p-4 rounded-lg bg-tertiary">
                <div class="flex items-center justify-center gap-4">
                    <h3 class="text-md font-semibold text-subtle">Session Countdown</h3>
                    <button data-action="openModal" data-modal="session-end-time-modal" class="px-3 py-1 btn-secondary rounded-lg text-xs font-semibold">Set End Time</button>
                </div>
                <div id="session-countdown" class="text-4xl font-bold my-2 text-main" style="color: var(--accent-primary); font-variant-numeric: tabular-nums;">--:--:--</div>
                <p id="session-motivation" class="text-sm text-subtle font-medium">Set an end time to begin.</p>
            </section>
            <hr class="border-main my-6">
            <section id="subjects-container">
                <div id="subjects-list" class="space-y-4"></div>
                <div id="completed-subjects-container" class="mt-8 hidden">
                    <h4 class="text-lg font-bold text-main mb-3 border-b border-main pb-2">Completed</h4>
                    <div id="subjects-done-list" class="space-y-4"></div>
                </div>
            </section>
        </div>
    </main>

    <!-- Modals -->
    <div id="theme-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4"><div class="bg-main rounded-2xl shadow-xl p-6 w-full max-w-sm"><h4 class="text-xl font-bold mb-5 text-main">Customize Theme</h4><div id="theme-options" class="space-y-6"></div><div class="flex justify-end mt-6"><button data-action="closeModal" class="btn btn-secondary">Close</button></div></div></div>
    <div id="manage-subjects-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4"><div class="bg-main rounded-2xl shadow-xl p-6 w-full max-w-md"><h4 class="text-xl font-bold mb-2 text-main">Manage Subjects</h4><p class="text-sm text-subtle mb-4">Add or remove subjects from your master list.</p><div class="flex gap-2 mb-4"><input type="text" id="new-subject-input" placeholder="Add new subject..." class="w-full p-2 input-main"><button data-action="addMasterSubject" class="btn btn-primary">Add</button></div><div id="master-subjects-list" class="space-y-2 mb-6 max-h-64 overflow-y-auto border-y border-main py-3"></div><div class="flex justify-end space-x-3"><button data-action="closeModal" class="btn btn-secondary">Done</button></div></div></div>
    <div id="edit-subjects-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4"><div class="bg-main rounded-2xl shadow-xl p-6 w-full max-w-md"><h4 class="text-xl font-bold mb-5 text-main">Select Subjects for Today</h4><div id="subjects-checklist" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6 max-h-64 overflow-y-auto"></div><div class="flex justify-end space-x-3"><button data-action="closeModal" class="btn btn-secondary">Cancel</button><button data-action="confirmEditSubjects" class="btn btn-primary">Save</button></div></div></div>
    <div id="randomize-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4"><div class="bg-main rounded-2xl shadow-xl p-6 w-full max-w-md"><h4 class="text-xl font-bold mb-5 text-main">How many subjects?</h4><div id="subject-count-options" class="grid grid-cols-4 sm:grid-cols-5 gap-3 mb-6"></div><div class="flex justify-end space-x-3"><button data-action="closeModal" class="btn btn-secondary">Cancel</button><button data-action="confirmRandomize" class="btn btn-primary">Generate</button></div></div></div>
    <div id="session-end-time-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4"><div class="bg-main rounded-2xl shadow-xl p-6 w-full max-w-xs"><h4 class="text-xl font-bold mb-4 text-main">Session End Time</h4><input type="time" id="session-end-time-input" class="w-full p-2 border rounded-lg mb-4 text-center text-lg input-main"><div class="flex justify-end space-x-3"><button data-action="closeModal" class="btn btn-secondary">Cancel</button><button data-action="confirmEndTime" class="btn btn-primary">Set</button></div></div></div>
    <div id="edit-hours-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4"><div class="bg-main rounded-2xl shadow-xl p-6 w-full max-w-xs"><h4 class="text-xl font-bold mb-2 text-main">Set Time for</h4><p id="edit-hours-subject-name" class="text-md mb-4 text-subtle"></p><input type="number" id="hours-input" min="0.5" step="0.25" class="w-full p-2 border rounded-lg mb-4 text-center text-lg input-main"><div class="flex justify-end space-x-3"><button data-action="closeModal" class="btn btn-secondary">Cancel</button><button data-action="confirmEditHours" class="btn btn-primary">Save</button></div></div></div>
    
<script>
document.addEventListener('DOMContentLoaded', () => {

    const state = {
        masterSubjects: [],
        studyData: {},
        settings: { theme: 'dark', accent: 'green', sessionEndTime: null },
        ui: { currentModal: null, openSubTaskPanels: new Set(), draggedSubjectName: null }
    };

    const ACTIVITY_TYPES = ['None', 'Lecture', 'Revision', 'Practice', 'Test'];
    const DOM = { sidebar: document.getElementById('sidebar'), sidebarOverlay: document.getElementById('sidebar-overlay'), todayDate: document.getElementById('today-date'), todayDay: document.getElementById('today-day'), progressSummary: document.getElementById('progress-summary'), subjectsList: document.getElementById('subjects-list'), subjectsDoneList: document.getElementById('subjects-done-list'), completedSubjectsContainer: document.getElementById('completed-subjects-container'), sessionCountdown: document.getElementById('session-countdown'), sessionMotivation: document.getElementById('session-motivation'), newSubjectInput: document.getElementById('new-subject-input'), masterSubjectsList: document.getElementById('master-subjects-list'), subjectsChecklist: document.getElementById('subjects-checklist'), subjectCountOptions: document.getElementById('subject-count-options'), sessionEndTimeInput: document.getElementById('session-end-time-input'), themeOptions: document.getElementById('theme-options'), hoursInput: document.getElementById('hours-input'), editHoursSubjectName: document.getElementById('edit-hours-subject-name') };
    
    const saveState = () => localStorage.setItem('studyPlannerState', JSON.stringify(state));

    const loadState = () => {
        const savedState = localStorage.getItem('studyPlannerState');
        if (savedState) {
            const parsedState = JSON.parse(savedState);
            Object.assign(state, parsedState);
            state.ui.openSubTaskPanels = new Set(Array.from(state.ui.openSubTaskPanels));
            Object.values(state.studyData).forEach(day => {
                day.forEach(subject => {
                    if (subject.subTasks && subject.subTasks.length > 0) {
                        subject.subTasks.forEach(task => {
                            if (task.status === undefined) task.status = 'None';
                            if (task.hours === undefined) task.hours = 0;
                        });
                        distributeSubTaskHours(subject);
                    }
                });
            });
        } else {
            // MODIFICATION: Default subject list updated as per your request.
            state.masterSubjects = ['DM', 'MATHS', 'APTITUDE', 'DL', 'TOC', 'COA', 'OS', 'DBMS', 'CN', 'CD', 'C', 'DAA', 'DSA'];
        }
    };
    
    // UTILITY & HELPER FUNCTIONS
    const formatDateKey = (date) => date.toISOString().split('T')[0];
    const distributeSubTaskHours = (subject) => { if (!subject || !subject.subTasks || !subject.subTasks.length === 0) return; const h = subject.hours / subject.subTasks.length; subject.subTasks.forEach(t => { t.hours = h; }); };
    
    const formatHoursAndMinutes = (totalHours) => {
        if (totalHours === 0 || !totalHours) return '0 min';
        const hours = Math.floor(totalHours);
        const minutes = Math.round((totalHours - hours) * 60);
        const hourString = hours > 0 ? `${hours} hr` : '';
        const minuteString = minutes > 0 ? `${minutes} min` : '';
        return [hourString, minuteString].filter(Boolean).join(' ');
    };

    const formatHoursAndMinutesCompact = (totalHours) => {
        if (totalHours === 0 || !totalHours) return '0m';
        const hours = Math.floor(totalHours);
        const minutes = Math.round((totalHours - hours) * 60);
        if (hours > 0 && minutes > 0) return `${hours}h ${minutes}m`;
        if (hours > 0) return `${hours}h`;
        return `${minutes}m`;
    };

    const createSmallProgressCircle = (progress) => {
        const size = 36; // w-9/h-9
        const sw = 4;
        const r = (size / 2) - (sw / 2);
        const circ = 2 * Math.PI * r;
        const o = circ - (progress / 100) * circ;
        return `<svg class="w-9 h-9 flex-shrink-0" viewBox="0 0 ${size} ${size}">
                    <circle class="progress-circle-bg" cx="${size/2}" cy="${size/2}" r="${r}" stroke-width="${sw}" fill="none"></circle>
                    <circle class="progress-circle-fg" cx="${size/2}" cy="${size/2}" r="${r}" stroke-width="${sw}" fill="none" stroke-dasharray="${circ}" stroke-dashoffset="${o}"></circle>
                </svg>`;
    };


    // RENDERING LOGIC
    const createProgressCircle = (progress, textContent = '') => { 
        const size = 56; // Corresponds to w-14/h-14 in Tailwind
        const sw = 6; // Stroke width
        const r = (size / 2) - (sw / 2); // Radius
        const circ = 2 * Math.PI * r;
        const o = circ - (progress / 100) * circ;
        const text = textContent ? `<text x="50%" y="50%" dy=".3em" text-anchor="middle" class="text-[11px] font-bold" fill="var(--text-primary)">${textContent}</text>` : ''; 
        return `<svg class="w-14 h-14 flex-shrink-0" viewBox="0 0 ${size} ${size}"><circle class="progress-circle-bg" cx="${size/2}" cy="${size/2}" r="${r}" stroke-width="${sw}" fill="none"></circle><circle class="progress-circle-fg" cx="${size/2}" cy="${size/2}" r="${r}" stroke-width="${sw}" fill="none" stroke-dasharray="${circ}" stroke-dashoffset="${o}"></circle>${text}</svg>`; 
    };
    const render = () => { document.documentElement.setAttribute('data-theme', state.settings.theme); document.documentElement.setAttribute('data-accent', state.settings.accent); const today = new Date(); DOM.todayDate.textContent = today.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }); DOM.todayDay.textContent = today.toLocaleDateString('en-US', { weekday: 'long' }); renderSubjects(); renderProgress(); renderCountdown(); };
    const renderSubjects = () => { const key = formatDateKey(new Date()); const subjects = state.studyData[key] || []; DOM.subjectsList.innerHTML = ''; DOM.subjectsDoneList.innerHTML = ''; const active = subjects.filter(s => !s.completed); const done = subjects.filter(s => s.completed); if (subjects.length === 0) DOM.subjectsList.innerHTML = `<p class="text-subtle text-center py-4">No subjects today. Click 'Randomize' or 'Edit'.</p>`; else if (active.length === 0) DOM.subjectsList.innerHTML = `<p class="text-subtle text-center py-4">All subjects complete! Great work! ðŸŽ‰</p>`; active.forEach(s => DOM.subjectsList.innerHTML += createSubjectHTML(s)); done.forEach(s => DOM.subjectsDoneList.innerHTML += createSubjectHTML(s)); DOM.completedSubjectsContainer.classList.toggle('hidden', done.length === 0); };
    
    const createSubjectHTML = (subject) => {
        const isPanelOpen = state.ui.openSubTaskPanels.has(subject.name);
        const subTaskProgress = subject.subTasks.length > 0 ? (subject.subTasks.filter(t => t.completed).length / subject.subTasks.length) * 100 : 0;
        const progress = subject.completed ? 100 : subTaskProgress;
        return `
            <div class="bg-tertiary rounded-xl overflow-hidden border border-secondary shadow-sm" draggable="true" data-subject-name="${subject.name}">
                <div class="flex items-center p-3 sm:p-4 gap-3">
                    <span class="drag-handle text-subtle" title="Drag to reorder">${createDragIcon()}</span>
                    <div data-action="toggleMainSubjectCompletion" data-subject-name="${subject.name}" class="custom-checkbox w-7 h-7 rounded-md cursor-pointer flex-shrink-0 ${subject.completed ? 'completed' : ''}"></div>
                    <div class="flex-grow min-w-0">
                        <label class="subject-label font-bold text-main text-xl ${subject.completed ? 'completed' : ''} truncate">${subject.name}</label>
                    </div>
                    <div data-action="openModal" data-modal="edit-hours-modal" data-subject-name="${subject.name}" class="relative cursor-pointer" title="Edit time for ${subject.name}">
                        ${createProgressCircle(progress, formatHoursAndMinutesCompact(subject.hours))}
                    </div>
                    <button data-action="toggleSubTaskPanel" data-subject-name="${subject.name}" class="p-1 rounded-full hover:bg-border-primary transition-colors">
                        <svg class="w-6 h-6 text-subtle transition-transform duration-200 ${isPanelOpen ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                <div class="subtask-container px-4 pb-4 border-t border-secondary ${isPanelOpen ? '' : 'hidden'}">
                    ${isPanelOpen ? createSubTasksHTML(subject) : ''}
                </div>
            </div>`;
    };
    
    const createSubTasksHTML = (subject) => { 
        let html = '<div class="space-y-3 pt-3">'; 
        subject.subTasks.forEach((task, index) => { 
            html += `<div class="flex items-center gap-2">
                        <div data-action="toggleSubTaskCompletion" data-subject-name="${subject.name}" data-task-index="${index}" class="custom-checkbox w-4 h-4 rounded-sm cursor-pointer shrink-0 ${task.completed?'completed':''}"></div>
                        <span class="subtask-label flex-grow text-sm text-main ${task.completed?'completed':''} min-w-0 break-words">${task.text}</span>
                        <span class="text-xs font-medium text-subtle bg-main px-2 py-0.5 rounded-md whitespace-nowrap">${formatHoursAndMinutes(task.hours)}</span>
                        <button data-action="cycleSubTaskStatus" data-subject-name="${subject.name}" data-task-index="${index}" class="status-btn status-${(task.status||'none').toLowerCase()}">${task.status||'None'}</button>
                        <button data-action="deleteSubTask" data-subject-name="${subject.name}" data-task-index="${index}" class="text-subtle font-bold text-lg px-2 rounded-full hover:bg-red-500/20 hover:text-red-500">&times;</button>
                    </div>`; 
        }); 
        html += `</div><div class="flex items-center mt-4"><input type="text" placeholder="Add task & press Enter" data-action-on-enter="addSubTaskOnEnter" data-subject-name="${subject.name}" class="bg-transparent w-full focus:outline-none text-sm text-main placeholder-text-secondary"></div>`; 
        return html; 
    };
    
    const renderProgress = () => {
        const key = formatDateKey(new Date());
        const subjects = state.studyData[key] || [];
        const totalHours = subjects.reduce((s, c) => s + c.hours, 0);
        const completedHours = subjects.reduce((s, c) => { if (c.completed) return s + c.hours; if (c.subTasks.length > 0) return s + (c.hours / c.subTasks.length) * c.subTasks.filter(t => t.completed).length; return s; }, 0);
        const progress = totalHours > 0 ? (completedHours / totalHours) * 100 : 0;
        DOM.progressSummary.innerHTML = `<span class="text-sm font-semibold whitespace-nowrap">${formatHoursAndMinutes(completedHours)} / ${formatHoursAndMinutes(totalHours)}</span> ${createSmallProgressCircle(progress)}`;
        renderMotivationMessage(totalHours - completedHours);
    };

    let countdownInterval = null;
    const renderCountdown = () => { if (countdownInterval) clearInterval(countdownInterval); if (!state.settings.sessionEndTime) { DOM.sessionCountdown.textContent = '--:--:--'; return; } const update = () => { const now = new Date(); const end = new Date(); const [h, m] = state.settings.sessionEndTime.split(':'); end.setHours(parseInt(h), parseInt(m), 0, 0); const diff = end.getTime() - now.getTime(); if (diff <= 0) { DOM.sessionCountdown.textContent = '00:00:00'; clearInterval(countdownInterval); return; } const hr = Math.floor(diff / 3600000).toString().padStart(2, '0'); const min = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0'); const sec = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0'); DOM.sessionCountdown.textContent = `${hr}:${min}:${sec}`; }; update(); countdownInterval = setInterval(update, 1000); };
    
    const renderMotivationMessage = (remHours) => {
        if (!state.settings.sessionEndTime) { DOM.sessionMotivation.innerHTML = 'Set an end time to begin.'; return; }
        if (remHours <= 0) { DOM.sessionMotivation.innerHTML = "All tasks done! You're amazing! ðŸš€"; return; }
        const now = new Date();
        const end = new Date();
        const [h, m] = state.settings.sessionEndTime.split(':');
        end.setHours(parseInt(h), parseInt(m), 0, 0);
        const diffMs = end.getTime() - now.getTime();
        let msg = `You have <strong>${formatHoursAndMinutes(remHours)}</strong> of tasks left.`;
        if (diffMs > 0) {
            const sessionMinsLeft = diffMs / 60000;
            msg += ` Session ends in <strong>${formatHoursAndMinutes(sessionMinsLeft / 60)}</strong>.`;
            if (remHours * 60 > sessionMinsLeft) {
                msg += ` <span style="color: var(--accent-danger);">Time to focus!</span>`;
            } else {
                msg += ` <span style="color: var(--accent-primary);">You're on track!</span>`;
            }
        } else {
            msg += ` Session has ended. Great work!`;
        }
        DOM.sessionMotivation.innerHTML = msg;
    };

    const openModal = (id, payload = null) => { const modal = document.getElementById(id); if (!modal) return; if (id === 'manage-subjects-modal') setupManageSubjectsModal(); if (id === 'edit-subjects-modal') setupEditSubjectsModal(); if (id === 'randomize-modal') setupRandomizeModal(); if (id === 'session-end-time-modal') setupEndTimeModal(); if (id === 'theme-modal') setupThemeModal(); if (id === 'edit-hours-modal') setupEditHoursModal(payload); state.ui.currentModal = modal; modal.classList.remove('hidden'); };
    const closeModal = () => { if (state.ui.currentModal) { state.ui.currentModal.classList.add('hidden'); state.ui.currentModal = null; } };
    const setupManageSubjectsModal = () => DOM.masterSubjectsList.innerHTML = state.masterSubjects.map(s => `<div class="flex items-center justify-between p-1"><label class="text-main">${s}</label><button data-action="deleteMasterSubject" data-subject-name="${s}" class="text-subtle font-bold text-xl px-2 rounded-full hover:bg-red-500/20 hover:text-red-500">&times;</button></div>`).join('');
    const setupEditSubjectsModal = () => { const key = formatDateKey(new Date()); const current = (state.studyData[key] || []).map(s => s.name); DOM.subjectsChecklist.innerHTML = state.masterSubjects.map(s => `<div class="flex items-center"><input type="checkbox" id="edit-${s}" value="${s}" class="w-4 h-4" ${current.includes(s)?'checked':''}><label for="edit-${s}" class="ml-2 text-sm font-medium text-main">${s}</label></div>`).join(''); };
    const setupRandomizeModal = () => { let html = ''; for (let i = 1; i <= state.masterSubjects.length; i++) { html += `<div><input type="radio" name="subject-count" id="count-${i}" value="${i}" class="hidden"><label for="count-${i}" class="block text-center p-3 border-2 border-main rounded-lg cursor-pointer">${i}</label></div>`; } DOM.subjectCountOptions.innerHTML = html; };
    const setupEndTimeModal = () => DOM.sessionEndTimeInput.value = state.settings.sessionEndTime;
    const setupEditHoursModal = (name) => { const subject = state.studyData[formatDateKey(new Date())]?.find(s => s.name === name); if(subject) { DOM.editHoursSubjectName.textContent = subject.name; DOM.hoursInput.value = subject.hours; DOM.hoursInput.dataset.subjectName = subject.name; } };
    const setupThemeModal = () => { const a = [ { n: 'green', c: '#22c55e' }, { n: 'blue', c: '#3b82f6' }, { n: 'purple', c: '#a855f7' }, { n: 'red', c: '#ef4444' } ]; DOM.themeOptions.innerHTML = `<div><h5 class="text-sm font-bold text-subtle mb-3">Theme</h5><div class="grid grid-cols-2 gap-4"><button data-action="setTheme" data-theme="light" class="btn btn-secondary ${state.settings.theme==='light'?'border-2 border-accent-primary':''}">Light</button><button data-action="setTheme" data-theme="dark" class="btn btn-secondary ${state.settings.theme==='dark'?'border-2 border-accent-primary':''}">Dark</button></div></div><div><h5 class="text-sm font-bold text-subtle mb-3">Accent</h5><div class="flex items-center justify-around gap-4">${a.map(x=>`<button data-action="setAccent" data-accent="${x.n}" class="w-12 h-12 rounded-full ${state.settings.accent===x.n?'ring-2 ring-offset-2 ring-accent-primary ring-offset-bg-main':''}" style="background-color:${x.c};"></button>`).join('')}</div></div>`; };

    const actions = {
        toggleSidebar: () => { const isOpen = DOM.sidebar.classList.contains('open'); if (isOpen) { DOM.sidebar.classList.remove('open'); DOM.sidebarOverlay.classList.add('opacity-0'); setTimeout(() => DOM.sidebarOverlay.classList.add('hidden'), 300); } else { DOM.sidebarOverlay.classList.remove('hidden'); setTimeout(() => { DOM.sidebar.classList.add('open'); DOM.sidebarOverlay.classList.remove('opacity-0'); }, 10); } },
        openModal: (el) => openModal(el.dataset.modal, el.dataset.subjectName),
        closeModal: () => closeModal(),
        setTheme: (el) => { state.settings.theme = el.dataset.theme; setupThemeModal(); render(); saveState(); },
        setAccent: (el) => { state.settings.accent = el.dataset.accent; setupThemeModal(); render(); saveState(); },
        addMasterSubject: (el) => { const name = DOM.newSubjectInput.value.trim(); if (name && !state.masterSubjects.find(s => s.toLowerCase() === name.toLowerCase())) { state.masterSubjects.push(name); DOM.newSubjectInput.value = ''; setupManageSubjectsModal(); saveState(); } },
        deleteMasterSubject: (el) => { state.masterSubjects = state.masterSubjects.filter(s => s !== el.dataset.subjectName); setupManageSubjectsModal(); saveState(); },
        confirmEditSubjects: () => { const key = formatDateKey(new Date()); const current = state.studyData[key] || []; const newData = []; DOM.subjectsChecklist.querySelectorAll('input:checked').forEach(cb => { const name = cb.value; const existing = current.find(s => s.name === name); newData.push(existing || { name, hours: 1, completed: false, subTasks: [] }); }); state.studyData[key] = newData; closeModal(); render(); saveState(); },
        confirmRandomize: () => { const opt = document.querySelector('input[name="subject-count"]:checked'); if (opt) { const num = parseInt(opt.value, 10); const shuffled = [...state.masterSubjects].sort(() => 0.5 - Math.random()); const random = shuffled.slice(0, num); state.studyData[formatDateKey(new Date())] = random.map(s => ({ name: s, hours: 1, completed: false, subTasks: [] })); closeModal(); render(); saveState(); } },
        confirmEditHours: (el) => { const name = DOM.hoursInput.dataset.subjectName; const hours = parseFloat(DOM.hoursInput.value); if (name && !isNaN(hours) && hours >= 0) { const subject = state.studyData[formatDateKey(new Date())]?.find(s => s.name === name); if (subject) { subject.hours = hours; distributeSubTaskHours(subject); } closeModal(); render(); saveState(); } else { DOM.hoursInput.classList.add('border-red-500'); setTimeout(() => DOM.hoursInput.classList.remove('border-red-500'), 1500); } },
        toggleMainSubjectCompletion: (el) => { const s = state.studyData[formatDateKey(new Date())]?.find(s => s.name === el.dataset.subjectName); if (s) { s.completed = !s.completed; s.subTasks.forEach(t => t.completed = s.completed); render(); saveState(); } },
        toggleSubTaskPanel: (el) => { const n = el.dataset.subjectName; if (state.ui.openSubTaskPanels.has(n)) state.ui.openSubTaskPanels.delete(n); else state.ui.openSubTaskPanels.add(n); renderSubjects(); },
        addSubTaskOnEnter: (el) => { const text = el.value.trim(); const s = state.studyData[formatDateKey(new Date())]?.find(s => s.name === el.dataset.subjectName); if (s && text) { s.subTasks.push({ text, completed: false, status: 'None', hours: 0 }); distributeSubTaskHours(s); el.value = ''; render(); saveState(); } },
        toggleSubTaskCompletion: (el) => { const { subjectName, taskIndex } = el.dataset; const s = state.studyData[formatDateKey(new Date())]?.find(s => s.name === subjectName); if (s && s.subTasks[taskIndex]) { s.subTasks[taskIndex].completed = !s.subTasks[taskIndex].completed; render(); saveState(); } },
        deleteSubTask: (el) => { const { subjectName, taskIndex } = el.dataset; const s = state.studyData[formatDateKey(new Date())]?.find(s => s.name === subjectName); if (s) { s.subTasks.splice(taskIndex, 1); distributeSubTaskHours(s); render(); saveState(); } },
        cycleSubTaskStatus: (el) => { const { subjectName, taskIndex } = el.dataset; const t = state.studyData[formatDateKey(new Date())]?.find(s => s.name === subjectName)?.subTasks[taskIndex]; if(t){ const cur = ACTIVITY_TYPES.indexOf(t.status || 'None'); t.status = ACTIVITY_TYPES[(cur + 1) % ACTIVITY_TYPES.length]; render(); saveState(); } },
        confirmEndTime: () => { state.settings.sessionEndTime = DOM.sessionEndTimeInput.value; closeModal(); render(); saveState(); },
    };

    document.body.addEventListener('click', (e) => { const t = e.target.closest('[data-action]'); if (t && actions[t.dataset.action]) actions[t.dataset.action](t); });
    document.body.addEventListener('keydown', (e) => { const t = e.target.closest('[data-action-on-enter]'); if (t && e.key === 'Enter' && actions[t.dataset.actionOnEnter]) { e.preventDefault(); actions[t.dataset.actionOnEnter](t, e); } });
    document.body.addEventListener('dragstart', (e) => { const t = e.target.closest('[data-subject-name]'); if (t) { state.ui.draggedSubjectName = t.dataset.subjectName; e.dataTransfer.effectAllowed = 'move'; t.classList.add('dragging'); } });
    document.body.addEventListener('dragend', (e) => { const t = e.target.closest('[data-subject-name]'); if (t) t.classList.remove('dragging'); state.ui.draggedSubjectName = null; });
    document.body.addEventListener('dragover', (e) => { e.preventDefault(); const t = e.target.closest('[data-subject-name]'); if (t && t.dataset.subjectName !== state.ui.draggedSubjectName) { document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); t.classList.add('drag-over'); } });
    document.body.addEventListener('dragleave', (e) => { const t = e.target.closest('[data-subject-name]'); if(t) t.classList.remove('drag-over'); });
    document.body.addEventListener('drop', (e) => { e.preventDefault(); const t = e.target.closest('[data-subject-name]'); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); if (t) { const subjects = state.studyData[formatDateKey(new Date())]; const from = subjects.findIndex(s => s.name === state.ui.draggedSubjectName); const to = subjects.findIndex(s => s.name === t.dataset.subjectName); if (from > -1 && to > -1) { const [removed] = subjects.splice(from, 1); subjects.splice(to, 0, removed); render(); saveState(); } } });
    const createDragIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg>`;
    
    const init = () => { loadState(); render(); };
    init();
});
</script>
</body>
</html>

