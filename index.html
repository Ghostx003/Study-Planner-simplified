<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Planner</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“š</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* THEME & COLOR SYSTEM */
        :root {
            --bg-primary: #f4f5f7; --bg-secondary: #ffffff; --bg-tertiary: #e5e7eb;
            --text-primary: #111827; --text-secondary: #6b7280;
            --border-primary: #d1d5db; --border-secondary: #e5e7eb;
            --accent-danger: #ef4444; --text-on-accent: #ffffff;
            --break-bg: #fff3e0;
        }
        html[data-theme="dark"] {
            --bg-primary: #111111; --bg-secondary: #181818; --bg-tertiary: #282828;
            --text-primary: #f5f5f5; --text-secondary: #a3a3a3;
            --border-primary: #3a3a3a; --border-secondary: #2d2d2d;
            --break-bg: #3a2e1c;
        }
        html[data-accent="green"] { --accent-primary: #22c55e; --accent-hover: #16a34a; }
        html[data-accent="blue"] { --accent-primary: #3b82f6; --accent-hover: #2563eb; }
        html[data-accent="purple"] { --accent-primary: #a855f7; --accent-hover: #9333ea; }
        html[data-accent="red"] { --accent-primary: #ef4444; --accent-hover: #dc2626; }
        html[data-accent="green"][data-theme="dark"] { --accent-translucent: rgba(34, 197, 94, 0.3); }
        html[data-accent="blue"][data-theme="dark"] { --accent-translucent: rgba(59, 130, 246, 0.3); }
        html[data-accent="purple"][data-theme="dark"] { --accent-translucent: rgba(168, 85, 247, 0.3); }
        html[data-accent="red"][data-theme="dark"] { --accent-translucent: rgba(239, 68, 68, 0.3); }
        html[data-accent="green"][data-theme="light"] { --accent-translucent: rgba(34, 197, 94, 0.2); }
        html[data-accent="blue"][data-theme="light"] { --accent-translucent: rgba(59, 130, 246, 0.2); }
        html[data-accent="purple"][data-theme="light"] { --accent-translucent: rgba(168, 85, 247, 0.2); }
        html[data-accent="red"][data-theme="light"] { --accent-translucent: rgba(239, 68, 68, 0.2); }

        /* BASE & COMPONENT STYLES */
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-primary);
            color: var(--text-primary); transition: background-color 0.2s, color 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .bg-main { background-color: var(--bg-secondary); }
        .text-main { color: var(--text-primary); }
        .text-subtle { color: var(--text-secondary); }
        .bg-tertiary { background-color: var(--bg-tertiary); }
        .border-main { border-color: var(--border-primary); }
        .border-secondary { border-color: var(--border-secondary); }
        .btn { padding: 0.5rem 1.2rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s, box-shadow 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .btn-primary { background-color: var(--accent-primary); color: var(--text-on-accent); }
        .btn-primary:hover { background-color: var(--accent-hover); }
        .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background-color: var(--border-primary); }
        .input-main { background-color: var(--bg-tertiary); border: 1px solid var(--border-primary); color: var(--text-primary); border-radius: 0.5rem; transition: border-color 0.2s, box-shadow 0.2s; }
        .input-main:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px var(--accent-translucent); }
        #sidebar { transition: transform 0.3s ease-in-out; transform: translateX(-100%); }
        #sidebar.open { transform: translateX(0); }
        #sidebar-overlay { transition: opacity 0.3s ease-in-out; background-color: rgba(0,0,0,0.5); }
        .custom-checkbox { border: 2px solid var(--border-primary); transition: all 0.2s; }
        .custom-checkbox.completed { background-color: var(--accent-primary); border-color: var(--accent-primary); }
        .custom-checkbox.completed::after {
            content: 'âœ“'; color: white; display: flex; font-weight: bold; align-items: center;
            justify-content: center; font-size: 1em; line-height: 1; height: 100%;
        }
        .subject-label.completed, .subtask-label.completed, .break-item.completed span { text-decoration: line-through; color: var(--text-secondary); }
        .drag-handle { cursor: grab; }
        .dragging { opacity: 0.5; background-color: var(--bg-tertiary); }
        .drag-over { border-top: 2px solid var(--accent-primary); }
        .progress-circle-bg { stroke: var(--border-primary); }
        .progress-circle-fg { stroke: var(--accent-primary); stroke-linecap: round; transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 0.5s ease; }
        .status-btn { padding: 0.2rem 0.6rem; border-radius: 9999px; font-weight: 600; font-size: 0.7rem; white-space: nowrap; }
        .status-none { background-color: rgba(107, 114, 128, 0.1); color: #6b7280; }
        .status-lecture { background-color: rgba(59, 130, 246, 0.1); color: #3b82f6; }
        .status-revision { background-color: rgba(168, 85, 247, 0.1); color: #a855f7; }
        .status-practice { background-color: rgba(249, 115, 22, 0.1); color: #f97316; }
        .status-test { background-color: rgba(239, 68, 68, 0.1); color: #ef4444; }
        
        .option-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.75rem; }
        .option-item {
            padding: 0.75rem; border: 2px solid var(--border-primary); border-radius: 0.5rem;
            text-align: center; font-weight: 600; cursor: pointer; transition: all 0.2s ease;
        }
        .option-item.selected {
            background-color: var(--accent-primary); color: var(--text-on-accent);
            border-color: var(--accent-primary); transform: scale(1.05);
        }
        .break-item {
            background-color: var(--break-bg);
        }
    </style>
</head>

<body class="transition-colors duration-300">
    <div id="sidebar-overlay" data-action="toggleSidebar" class="fixed inset-0 z-40 hidden opacity-0"></div>
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-64 bg-main shadow-xl p-4 z-50 border-r border-secondary">
        <h2 class="text-xl font-bold mb-6 text-main">Menu</h2>
        <nav><ul>
            <li><button data-action="openModal" data-modal="manage-subjects-modal" class="w-full text-left py-2 px-3 rounded-md hover:bg-tertiary font-semibold transition-colors text-main">Manage Subjects</button></li>
            <li><button data-action="openModal" data-modal="theme-modal" class="w-full text-left py-2 px-3 rounded-md hover:bg-tertiary font-semibold transition-colors text-main">Customize Theme</button></li>
             <li><button data-action="resetApp" class="w-full text-left py-2 px-3 rounded-md hover:bg-tertiary font-semibold transition-colors text-main">Reset App</button></li>
        </ul></nav>
    </aside>
    <main class="flex items-start justify-center min-h-screen p-2 sm:p-4">
        <div class="w-full max-w-3xl bg-main rounded-2xl shadow-lg p-4 sm:p-6 border border-secondary">
            <header class="flex items-center justify-between mb-6 flex-wrap gap-y-4">
                <div class="flex items-center space-x-3">
                    <button data-action="toggleSidebar" class="p-2 rounded-full hover:bg-tertiary transition-colors">
                        <svg class="w-6 h-6 text-subtle" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <div>
                        <h1 id="today-date" class="text-xl font-bold text-main"></h1>
                        <p id="today-day" class="text-sm text-subtle font-medium"></p>
                    </div>
                    <button data-action="openModal" data-modal="generate-schedule-modal" class="btn btn-primary text-sm sm:hidden">
                        Generate
                    </button>
                </div>
                
                <div class="flex items-center space-x-2 w-full sm:w-auto justify-end">
                    <div id="progress-summary" class="flex items-center space-x-2 text-md font-semibold text-main"></div>
                    <button data-action="addBreak" class="btn btn-secondary text-sm">
                        Break
                    </button>
                    <button data-action="openModal" data-modal="edit-subjects-modal" class="btn btn-secondary text-sm">Edit</button>
                    <button data-action="openModal" data-modal="generate-schedule-modal" class="btn btn-primary text-sm hidden sm:inline-flex">
                        Generate Schedule
                    </button>
                </div>
            </header>

            <section id="session-timer-container" class="text-center mb-6 p-4 rounded-lg bg-tertiary">
                <div class="flex items-center justify-center gap-4">
                    <h3 class="text-md font-semibold text-subtle">Session Countdown</h3>
                    <button data-action="openModal" data-modal="session-end-time-modal" class="px-3 py-1 btn-secondary rounded-lg text-xs font-semibold">Set End Time</button>
                </div>
                <div id="session-countdown" class="text-4xl font-bold my-2 text-main" style="color: var(--accent-primary); font-variant-numeric: tabular-nums;">--:--:--</div>
                <p id="session-motivation" class="text-sm text-subtle font-medium">Set an end time to begin.</p>
            </section>
            <hr class="border-main my-6">
            <section id="subjects-container">
                <div id="subjects-list" class="space-y-4"></div>
                <div id="completed-subjects-container" class="mt-8 hidden">
                    <h4 class="text-lg font-bold text-main mb-3 border-b border-main pb-2">Completed</h4>
                    <div id="subjects-done-list" class="space-y-4"></div>
                </div>
            </section>
        </div>
    </main>

    <div id="theme-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4"><div class="bg-main rounded-2xl shadow-xl p-6 w-full max-w-sm"><h4 class="text-xl font-bold mb-5 text-main">Customize Theme</h4><div id="theme-options" class="space-y-6"></div><div class="flex justify-end mt-6"><button data-action="closeModal" class="btn btn-secondary">Close</button></div></div></div>
    <div id="manage-subjects-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4"><div class="bg-main rounded-2xl shadow-xl p-6 w-full max-w-md"><h4 class="text-xl font-bold mb-2 text-main">Manage Subjects</h4><p class="text-sm text-subtle mb-4">Add or remove subjects from your master list.</p><div class="flex gap-2 mb-4"><input type="text" id="new-subject-input" placeholder="Add new subject..." class="w-full p-2 input-main"><button data-action="addMasterSubject" class="btn btn-primary">Add</button></div><div id="master-subjects-list" class="space-y-2 mb-6 max-h-64 overflow-y-auto border-y border-main py-3"></div><div class="flex justify-end space-x-3"><button data-action="closeModal" class="btn btn-secondary">Done</button></div></div></div>
    <div id="edit-subjects-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4"><div class="bg-main rounded-2xl shadow-xl p-6 w-full max-w-md"><h4 class="text-xl font-bold mb-5 text-main">Select Subjects for Today</h4><div id="subjects-checklist" class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6 max-h-64 overflow-y-auto"></div><div class="flex justify-end space-x-3"><button data-action="closeModal" class="btn btn-secondary">Cancel</button><button data-action="confirmEditSubjects" class="btn btn-primary">Save</button></div></div></div>
    
    <div id="generate-schedule-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-main rounded-2xl shadow-xl w-full max-w-lg flex flex-col max-h-[90vh]">
            <div class="p-6 pb-4 flex-shrink-0">
                <h4 class="text-xl font-bold text-main">Generate a New Schedule</h4>
            </div>
            <div class="px-6 space-y-6 overflow-y-auto flex-grow">
                <div>
                    <h5 class="text-sm font-bold text-subtle mb-2">1. When do you want to start?</h5>
                    <div id="start-time-selection" class="option-grid"></div>
                </div>
                <div>
                    <h5 class="text-sm font-bold text-subtle mb-2">2. What's the default duration? (Hours)</h5>
                    <div id="default-duration-selection" class="option-grid"></div>
                </div>
                <div>
                    <h5 class="text-sm font-bold text-subtle mb-2">3. How many subjects?</h5>
                    <div id="subject-count-selection" class="option-grid"></div>
                </div>
            </div>
            <div class="flex justify-end space-x-3 p-6 pt-4 mt-auto flex-shrink-0 border-t border-secondary">
                <button data-action="closeModal" class="btn btn-secondary">Cancel</button>
                <button data-action="confirmGenerateSchedule" id="confirm-generate-btn" class="btn btn-primary" disabled>Create Schedule</button>
            </div>
        </div>
    </div>
    
    <div id="session-end-time-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4"><div class="bg-main rounded-2xl shadow-xl p-6 w-full max-w-xs"><h4 class="text-xl font-bold mb-4 text-main">Session End Time</h4><input type="time" id="session-end-time-input" class="w-full p-2 border rounded-lg mb-4 text-center text-lg input-main"><div class="flex justify-end space-x-3"><button data-action="closeModal" class="btn btn-secondary">Cancel</button><button data-action="confirmEndTime" class="btn btn-primary">Set</button></div></div></div>
    
    <div id="edit-hours-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4"><div class="bg-main rounded-2xl shadow-xl p-6 w-full max-w-xs">
        <h4 id="edit-hours-title" class="text-xl font-bold mb-2 text-main">Set Duration</h4>
        <p id="edit-hours-subject-name" class="text-md mb-4 text-subtle"></p>
        <input type="number" id="hours-input" min="0.25" step="0.25" class="w-full p-2 border rounded-lg mb-4 text-center text-lg input-main">
        <div class="flex justify-end space-x-3">
            <button data-action="closeModal" class="btn btn-secondary">Cancel</button>
            <button data-action="confirmEditHours" class="btn btn-primary">Save</button>
        </div>
    </div></div>
    
<script>
document.addEventListener('DOMContentLoaded', () => {

    const state = {
        masterSubjects: [],
        studyData: {},
        settings: { theme: 'dark', accent: 'green', sessionEndTime: null },
        ui: { currentModal: null, openSubTaskPanels: new Set(), draggedItemId: null },
        scheduleParams: { startTime: null, subjectCount: null, defaultDuration: null }
    };

    const ACTIVITY_TYPES = ['None', 'Lecture', 'Revision', 'Practice', 'Test'];
    const DOM = {
        sidebar: document.getElementById('sidebar'), sidebarOverlay: document.getElementById('sidebar-overlay'), todayDate: document.getElementById('today-date'), todayDay: document.getElementById('today-day'), progressSummary: document.getElementById('progress-summary'), subjectsList: document.getElementById('subjects-list'), subjectsDoneList: document.getElementById('subjects-done-list'), completedSubjectsContainer: document.getElementById('completed-subjects-container'), sessionCountdown: document.getElementById('session-countdown'), sessionMotivation: document.getElementById('session-motivation'), newSubjectInput: document.getElementById('new-subject-input'), masterSubjectsList: document.getElementById('master-subjects-list'), subjectsChecklist: document.getElementById('subjects-checklist'), sessionEndTimeInput: document.getElementById('session-end-time-input'), themeOptions: document.getElementById('theme-options'), hoursInput: document.getElementById('hours-input'), 
        editHoursTitle: document.getElementById('edit-hours-title'),
        editHoursSubjectName: document.getElementById('edit-hours-subject-name'),
        startTimeSelection: document.getElementById('start-time-selection'), defaultDurationSelection: document.getElementById('default-duration-selection'), subjectCountSelection: document.getElementById('subject-count-selection'), confirmGenerateBtn: document.getElementById('confirm-generate-btn'),
    };
    
    const saveState = () => localStorage.setItem('studyPlannerState', JSON.stringify(state));

    const loadState = () => {
        const savedState = localStorage.getItem('studyPlannerState');
        if (savedState) {
            const parsedState = JSON.parse(savedState);
            Object.keys(parsedState).forEach(key => {
                if (typeof parsedState[key] === 'object' && parsedState[key] !== null && !Array.isArray(parsedState[key])) {
                    state[key] = { ...state[key], ...parsedState[key] };
                } else {
                    state[key] = parsedState[key];
                }
            });
            
            state.ui.openSubTaskPanels = new Set(Array.from(state.ui.openSubTaskPanels || []));
            
            Object.values(state.studyData).forEach(day => {
                day.forEach(item => {
                    if (!item.id) item.id = Date.now() + Math.random();
                    if (!item.type) item.type = 'subject';
                    if (item.type === 'subject') {
                         if (item.subTasks && item.subTasks.length > 0) {
                            item.subTasks.forEach(task => { if (task.status === undefined) task.status = 'None'; });
                        }
                    }
                    if (item.startTime) item.startTime = new Date(item.startTime);
                });
            });
        } else {
            state.masterSubjects = ['DM', 'MATHS', 'APTITUDE', 'DL', 'TOC', 'COA', 'OS', 'DBMS', 'CN', 'CD', 'C', 'DAA', 'DSA'];
        }
    };
    
    const formatDateKey = (date) => date.toISOString().split('T')[0];
    const distributeSubTaskHours = (subject) => { if (!subject || !subject.subTasks || !subject.subTasks.length === 0) return; const h = subject.durationHours / subject.subTasks.length; subject.subTasks.forEach(t => { t.hours = h; }); };
    
    const calculateEndTime = (startTime, durationHours) => new Date(startTime.getTime() + durationHours * 60 * 60 * 1000);
    const formatTime = (date) => {
        if (!date || !(date instanceof Date)) return 'N/A';
        return date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
    }
    const formatTimeTo24hr = (date) => {
        if (!date || !(date instanceof Date)) return '';
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
    };

    const recalculateStartTimes = (startIndex = 0) => {
        const key = formatDateKey(new Date());
        const schedule = state.studyData[key] || [];
        if (schedule.length === 0) return;
        for (let i = startIndex; i < schedule.length; i++) {
            if (i > 0) {
                const prevItem = schedule[i - 1];
                if(prevItem.startTime) {
                    schedule[i].startTime = calculateEndTime(prevItem.startTime, prevItem.durationHours);
                }
            }
        }
    };

    const formatHoursAndMinutes = (totalHours) => {
        if (totalHours === 0 || !totalHours) return '0 min';
        const hours = Math.floor(totalHours);
        const minutes = Math.round((totalHours - hours) * 60);
        const hourString = hours > 0 ? `${hours} hr` : '';
        const minuteString = minutes > 0 ? `${minutes} min` : '';
        return [hourString, minuteString].filter(Boolean).join(' ');
    };

    const formatHoursAndMinutesCompact = (totalHours) => {
        if (totalHours === 0 || !totalHours) return '0m';
        const hours = Math.floor(totalHours);
        const minutes = Math.round((totalHours - hours) * 60);
        if (hours > 0 && minutes > 0) return `${hours}h ${minutes}m`;
        if (hours > 0) return `${hours}h`;
        return `${minutes}m`;
    };

    const createSmallProgressCircle = (progress) => {
        const size = 36; const sw = 4; const r = (size / 2) - (sw / 2); const circ = 2 * Math.PI * r; const o = circ - (progress / 100) * circ;
        return `<svg class="w-9 h-9 flex-shrink-0" viewBox="0 0 ${size} ${size}"><circle class="progress-circle-bg" cx="${size/2}" cy="${size/2}" r="${r}" stroke-width="${sw}" fill="none"></circle><circle class="progress-circle-fg" cx="${size/2}" cy="${size/2}" r="${r}" stroke-width="${sw}" fill="none" stroke-dasharray="${circ}" stroke-dashoffset="${o}"></circle></svg>`;
    };

    const createProgressCircle = (progress, textContent = '') => { 
        const size = 56; const sw = 6; const r = (size / 2) - (sw / 2); const circ = 2 * Math.PI * r; const o = circ - (progress / 100) * circ;
        const text = textContent ? `<text x="50%" y="50%" dy=".3em" text-anchor="middle" class="text-[11px] font-bold" fill="var(--text-primary)">${textContent}</text>` : ''; 
        return `<svg class="w-14 h-14 flex-shrink-0" viewBox="0 0 ${size} ${size}"><circle class="progress-circle-bg" cx="${size/2}" cy="${size/2}" r="${r}" stroke-width="${sw}" fill="none"></circle><circle class="progress-circle-fg" cx="${size/2}" cy="${size/2}" r="${r}" stroke-width="${sw}" fill="none" stroke-dasharray="${circ}" stroke-dashoffset="${o}"></circle>${text}</svg>`; 
    };
    
    const render = () => { document.documentElement.setAttribute('data-theme', state.settings.theme); document.documentElement.setAttribute('data-accent', state.settings.accent); const today = new Date(); DOM.todayDate.textContent = today.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }); DOM.todayDay.textContent = today.toLocaleDateString('en-US', { weekday: 'long' }); renderSubjects(); renderProgress(); renderCountdown(); };
    
    const renderSubjects = () => {
        const key = formatDateKey(new Date()); const items = state.studyData[key] || [];
        DOM.subjectsList.innerHTML = ''; DOM.subjectsDoneList.innerHTML = '';
        const active = items.filter(s => !s.completed); const done = items.filter(s => s.completed);
        if (items.length === 0) DOM.subjectsList.innerHTML = `<p class="text-subtle text-center py-4">No schedule for today. Click 'Generate Schedule'.</p>`;
        else if (active.length === 0) DOM.subjectsList.innerHTML = `<p class="text-subtle text-center py-4">All tasks complete! Great work! ðŸŽ‰</p>`;
        active.forEach(item => DOM.subjectsList.innerHTML += createItemHTML(item));
        done.forEach(item => DOM.subjectsDoneList.innerHTML += createItemHTML(item));
        DOM.completedSubjectsContainer.classList.toggle('hidden', done.length === 0);
    };

    const createItemHTML = (item) => {
        if (item.type === 'break') return createBreakHTML(item);
        return createSubjectHTML(item);
    };
    
    const createBreakHTML = (item) => {
        return `
            <div class="break-item rounded-xl p-3 sm:p-4 flex items-center justify-between gap-3 border border-secondary shadow-sm ${item.completed ? 'completed opacity-60' : ''}" data-item-id="${item.id}">
                 <div data-action="toggleMainCompletion" data-item-id="${item.id}" class="custom-checkbox w-7 h-7 rounded-md cursor-pointer flex-shrink-0 ${item.completed ? 'completed' : ''}"></div>
                <div data-action="openModal" data-modal="edit-hours-modal" data-item-id="${item.id}" class="flex items-center gap-3 flex-grow text-center justify-center cursor-pointer" title="Edit break duration">
                    <i class="fas fa-coffee text-xl text-subtle"></i>
                    <span class="font-bold text-main">Break</span>
                    <span class="text-sm text-subtle">(${formatHoursAndMinutes(item.durationHours)})</span>
                </div>
                <button data-action="deleteItem" data-item-id="${item.id}" class="text-subtle font-bold text-lg px-2 rounded-full hover:bg-red-500/20 hover:text-red-500">&times;</button>
            </div>`;
    };

    const createSubjectHTML = (subject) => {
        const isPanelOpen = state.ui.openSubTaskPanels.has(subject.name);
        const subTaskProgress = subject.subTasks.length > 0 ? (subject.subTasks.filter(t => t.completed).length / subject.subTasks.length) * 100 : 0;
        const progress = subject.completed ? 100 : subTaskProgress;
        return `
            <div class="bg-tertiary rounded-xl overflow-hidden border border-secondary shadow-sm" draggable="true" data-item-id="${subject.id}">
                <div class="flex items-center p-3 sm:p-4 gap-3">
                    <span class="drag-handle text-subtle" title="Drag to reorder">${createDragIcon()}</span>
                    <div data-action="toggleMainCompletion" data-item-id="${subject.id}" class="custom-checkbox w-7 h-7 rounded-md cursor-pointer flex-shrink-0 ${subject.completed ? 'completed' : ''}"></div>
                    <div class="flex-grow min-w-0">
                        <div class="flex flex-col items-start sm:flex-row sm:items-center sm:gap-2">
                            <span data-action="editStartTime" data-item-id="${subject.id}" title="Edit start time" class="time-display whitespace-nowrap font-bold text-main text-base cursor-pointer hover:opacity-75 transition-opacity" style="color: var(--accent-primary);">${formatTime(subject.startTime)}</span>
                            <label class="subject-label font-bold text-main text-xl ${subject.completed ? 'completed' : ''} truncate">${subject.name}</label>
                        </div>
                    </div>
                    <div data-action="openModal" data-modal="edit-hours-modal" data-item-id="${subject.id}" class="relative cursor-pointer" title="Edit time for ${subject.name}">
                        ${createProgressCircle(progress, formatHoursAndMinutesCompact(subject.durationHours))}
                    </div>
                    <button data-action="toggleSubTaskPanel" data-item-id="${subject.id}" class="p-1 rounded-full hover:bg-border-primary transition-colors">
                        <svg class="w-6 h-6 text-subtle transition-transform duration-200 ${isPanelOpen ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                <div class="subtask-container px-4 pb-4 border-t border-secondary ${isPanelOpen ? '' : 'hidden'}">
                    ${isPanelOpen ? createSubTasksHTML(subject) : ''}
                </div>
            </div>`;
    };
    
    const createSubTasksHTML = (subject) => { 
        let html = '<div class="space-y-3 pt-3">'; 
        subject.subTasks.forEach((task, index) => { 
            html += `<div class="flex items-center gap-2"><div data-action="toggleSubTaskCompletion" data-item-id="${subject.id}" data-task-index="${index}" class="custom-checkbox w-4 h-4 rounded-sm cursor-pointer shrink-0 ${task.completed?'completed':''}"></div><span class="subtask-label flex-grow text-sm text-main ${task.completed?'completed':''} min-w-0 break-words">${task.text}</span><span class="text-xs font-medium text-subtle bg-main px-2 py-0.5 rounded-md whitespace-nowrap">${formatHoursAndMinutes(task.hours)}</span><button data-action="cycleSubTaskStatus" data-item-id="${subject.id}" data-task-index="${index}" class="status-btn status-${(task.status||'none').toLowerCase()}">${task.status||'None'}</button><button data-action="deleteSubTask" data-item-id="${subject.id}" data-task-index="${index}" class="text-subtle font-bold text-lg px-2 rounded-full hover:bg-red-500/20 hover:text-red-500">&times;</button></div>`; 
        }); 
        html += `</div><div class="flex items-center mt-4"><input type="text" placeholder="Add task & press Enter" data-action-on-enter="addSubTaskOnEnter" data-item-id="${subject.id}" class="bg-transparent w-full focus:outline-none text-sm text-main placeholder-text-secondary"></div>`; 
        return html; 
    };
    
    const renderProgress = () => {
        const key = formatDateKey(new Date()); const items = (state.studyData[key] || []).filter(item => item.type === 'subject');
        const totalHours = items.reduce((s, c) => s + c.durationHours, 0);
        const completedHours = items.reduce((s, c) => { if (c.completed) return s + c.durationHours; if (c.subTasks.length > 0) return s + (c.durationHours / c.subTasks.length) * c.subTasks.filter(t => t.completed).length; return s; }, 0);
        const progress = totalHours > 0 ? (completedHours / totalHours) * 100 : 0;
        DOM.progressSummary.innerHTML = `<span class="text-sm font-semibold whitespace-nowrap">${formatHoursAndMinutes(completedHours)} / ${formatHoursAndMinutes(totalHours)}</span> ${createSmallProgressCircle(progress)}`;
        renderMotivationMessage(totalHours - completedHours);
    };

    let countdownInterval = null;
    const renderCountdown = () => { if (countdownInterval) clearInterval(countdownInterval); if (!state.settings.sessionEndTime) { DOM.sessionCountdown.textContent = '--:--:--'; return; } const update = () => { const now = new Date(); const end = new Date(); const [h, m] = state.settings.sessionEndTime.split(':'); end.setHours(parseInt(h), parseInt(m), 0, 0); const diff = end.getTime() - now.getTime(); if (diff <= 0) { DOM.sessionCountdown.textContent = '00:00:00'; clearInterval(countdownInterval); return; } const hr = Math.floor(diff / 3600000).toString().padStart(2, '0'); const min = Math.floor((diff % 3600000) / 60000).toString().padStart(2, '0'); const sec = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0'); DOM.sessionCountdown.textContent = `${hr}:${min}:${sec}`; }; update(); countdownInterval = setInterval(update, 1000); };
    
    const renderMotivationMessage = (remHours) => {
        if (!state.settings.sessionEndTime) { DOM.sessionMotivation.innerHTML = 'Set an end time to begin.'; return; }
        if (remHours <= 0) { DOM.sessionMotivation.innerHTML = "All tasks done! You're amazing! ðŸš€"; return; }
        const now = new Date(); const end = new Date(); const [h, m] = state.settings.sessionEndTime.split(':'); end.setHours(parseInt(h), parseInt(m), 0, 0); const diffMs = end.getTime() - now.getTime();
        let msg = `You have <strong>${formatHoursAndMinutes(remHours)}</strong> of tasks left.`;
        if (diffMs > 0) {
            const sessionMinsLeft = diffMs / 60000; msg += ` Session ends in <strong>${formatHoursAndMinutes(sessionMinsLeft / 60)}</strong>.`;
            if (remHours * 60 > sessionMinsLeft) { msg += ` <span style="color: var(--accent-danger);">Time to focus!</span>`; } else { msg += ` <span style="color: var(--accent-primary);">You're on track!</span>`; }
        } else { msg += ` Session has ended. Great work!`; }
        DOM.sessionMotivation.innerHTML = msg;
    };

    const openModal = (id, payload = null) => { const modal = document.getElementById(id); if (!modal) return; if (id === 'manage-subjects-modal') setupManageSubjectsModal(); if (id === 'edit-subjects-modal') setupEditSubjectsModal(); if (id === 'generate-schedule-modal') setupGenerateScheduleModal(); if (id === 'session-end-time-modal') setupEndTimeModal(); if (id === 'theme-modal') setupThemeModal(); if (id === 'edit-hours-modal') setupEditHoursModal(payload); state.ui.currentModal = modal; modal.classList.remove('hidden'); };
    const closeModal = () => { if (state.ui.currentModal) { state.ui.currentModal.classList.add('hidden'); state.ui.currentModal = null; } };
    const setupManageSubjectsModal = () => DOM.masterSubjectsList.innerHTML = state.masterSubjects.map(s => `<div class="flex items-center justify-between p-1"><label class="text-main">${s}</label><button data-action="deleteMasterSubject" data-subject-name="${s}" class="text-subtle font-bold text-xl px-2 rounded-full hover:bg-red-500/20 hover:text-red-500">&times;</button></div>`).join('');
    const setupEditSubjectsModal = () => { const key = formatDateKey(new Date()); const current = (state.studyData[key] || []).filter(i => i.type === 'subject').map(s => s.name); DOM.subjectsChecklist.innerHTML = state.masterSubjects.map(s => `<div class="flex items-center"><input type="checkbox" id="edit-${s}" value="${s}" class="w-4 h-4" ${current.includes(s)?'checked':''}><label for="edit-${s}" class="ml-2 text-sm font-medium text-main">${s}</label></div>`).join(''); };
    const setupEndTimeModal = () => DOM.sessionEndTimeInput.value = state.settings.sessionEndTime;
    
    const setupEditHoursModal = (itemId) => {
        const item = state.studyData[formatDateKey(new Date())]?.find(s => s.id == itemId);
        if(item) {
            DOM.hoursInput.dataset.itemId = item.id;
            if (item.type === 'subject') {
                DOM.editHoursTitle.textContent = "Set Duration (Hours)";
                DOM.editHoursSubjectName.textContent = item.name;
                DOM.editHoursSubjectName.style.display = 'block';
                DOM.hoursInput.value = item.durationHours;
                DOM.hoursInput.min = "0.25";
                DOM.hoursInput.step = "0.25";
            } else if (item.type === 'break') {
                DOM.editHoursTitle.textContent = "Set Break Duration (Mins)";
                DOM.editHoursSubjectName.style.display = 'none';
                DOM.hoursInput.value = item.durationHours * 60;
                DOM.hoursInput.min = "5";
                DOM.hoursInput.step = "5";
            }
        }
    };

    const setupThemeModal = () => { const a = [ { n: 'green', c: '#22c55e' }, { n: 'blue', c: '#3b82f6' }, { n: 'purple', c: '#a855f7' }, { n: 'red', c: '#ef4444' } ]; DOM.themeOptions.innerHTML = `<div><h5 class="text-sm font-bold text-subtle mb-3">Theme</h5><div class="grid grid-cols-2 gap-4"><button data-action="setTheme" data-theme="light" class="btn btn-secondary ${state.settings.theme==='light'?'border-2 border-main':''}" style="${state.settings.theme==='light'?'border-color: var(--accent-primary)':''}">Light</button><button data-action="setTheme" data-theme="dark" class="btn btn-secondary ${state.settings.theme==='dark'?'border-2 border-main':''}" style="${state.settings.theme==='dark'?'border-color: var(--accent-primary)':''}">Dark</button></div></div><div><h5 class="text-sm font-bold text-subtle mb-3">Accent</h5><div class="flex items-center justify-around gap-4">${a.map(x=>`<button data-action="setAccent" data-accent="${x.n}" class="w-12 h-12 rounded-full ${state.settings.accent===x.n?'ring-2 ring-offset-2 ring-offset-bg-main':''}" style="background-color:${x.c}; ${state.settings.accent===x.n?'border-color: var(--accent-primary)':''}"></button>`).join('')}</div></div>`; };
    
    const setupGenerateScheduleModal = () => {
        state.scheduleParams = { startTime: null, subjectCount: null, defaultDuration: null };
        const createOptionItems = (container, options, dataAttr, settingKey) => { container.innerHTML = options.map(opt => `<div class="option-item" data-action="handleOptionSelection" data-${dataAttr}="${opt.value}" data-setting-key="${settingKey}">${opt.label}</div>`).join(''); };
        const timeOptions = [];
        for (let i = 6; i <= 16; i++) { timeOptions.push({ label: `${i <= 12 ? i : i - 12}:00 ${i < 12 ? 'AM' : 'PM'}`, value: `${i}:00` }); }
        createOptionItems(DOM.startTimeSelection, timeOptions, 'time', 'startTime');
        createOptionItems(DOM.defaultDurationSelection, [0.5, 1, 1.5, 2, 2.5, 3].map(h => ({ label: `${h} hr`, value: h })), 'duration', 'defaultDuration');
        createOptionItems(DOM.subjectCountSelection, Array.from({ length: state.masterSubjects.length }, (_, i) => ({ label: i + 1, value: i + 1 })), 'count', 'subjectCount');
        DOM.confirmGenerateBtn.disabled = true;
    };

    const actions = {
        toggleSidebar: () => { const isOpen = DOM.sidebar.classList.contains('open'); if (isOpen) { DOM.sidebar.classList.remove('open'); DOM.sidebarOverlay.classList.add('opacity-0'); setTimeout(() => DOM.sidebarOverlay.classList.add('hidden'), 300); } else { DOM.sidebarOverlay.classList.remove('hidden'); setTimeout(() => { DOM.sidebar.classList.add('open'); DOM.sidebarOverlay.classList.remove('opacity-0'); }, 10); } },
        openModal: (el) => openModal(el.dataset.modal, el.dataset.itemId),
        closeModal: () => closeModal(),
        setTheme: (el) => { state.settings.theme = el.dataset.theme; setupThemeModal(); render(); saveState(); },
        setAccent: (el) => { state.settings.accent = el.dataset.accent; setupThemeModal(); render(); saveState(); },
        addMasterSubject: (el) => { const name = DOM.newSubjectInput.value.trim(); if (name && !state.masterSubjects.find(s => s.toLowerCase() === name.toLowerCase())) { state.masterSubjects.push(name); DOM.newSubjectInput.value = ''; setupManageSubjectsModal(); saveState(); } },
        deleteMasterSubject: (el) => { state.masterSubjects = state.masterSubjects.filter(s => s !== el.dataset.subjectName); setupManageSubjectsModal(); saveState(); },
        
        editStartTime: (el) => {
            const itemId = el.dataset.itemId;
            const item = state.studyData[formatDateKey(new Date())]?.find(i => i.id == itemId);
            if (!item) return;

            const timeDisplaySpan = el;
            const container = el.parentElement;

            const input = document.createElement('input');
            input.type = 'time';
            input.className = 'input-main text-sm p-0.5 w-24 rounded-md';
            input.value = formatTimeTo24hr(item.startTime);

            timeDisplaySpan.style.display = 'none';
            container.prepend(input);
            input.focus();

            const saveTime = () => {
                const [newHour, newMinute] = input.value.split(':');
                if (newHour && newMinute) {
                    item.startTime.setHours(parseInt(newHour), parseInt(newMinute));
                    const schedule = state.studyData[formatDateKey(new Date())];
                    const itemIndex = schedule.findIndex(i => i.id == itemId);
                    recalculateStartTimes(itemIndex + 1);
                    saveState();
                }
                render(); 
            };

            input.addEventListener('blur', saveTime);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') input.blur();
                if (e.key === 'Escape') {
                    input.removeEventListener('blur', saveTime);
                    render();
                }
            });
        },

        confirmEditSubjects: () => {
            const key = formatDateKey(new Date()); const schedule = state.studyData[key] || []; const selectedNames = Array.from(DOM.subjectsChecklist.querySelectorAll('input:checked')).map(cb => cb.value);
            let newSchedule = schedule.filter(item => item.type === 'break' || selectedNames.includes(item.name));
            const currentNames = newSchedule.map(item => item.name);
            selectedNames.forEach(name => { if (!currentNames.includes(name)) { newSchedule.push({ id: Date.now() + Math.random(), type: 'subject', name, durationHours: 1, completed: false, subTasks: [], startTime: null }); } });
            state.studyData[key] = newSchedule;
            recalculateStartTimes(); closeModal(); render(); saveState();
        },

        confirmEditHours: (el) => {
            const itemId = DOM.hoursInput.dataset.itemId;
            const value = parseFloat(DOM.hoursInput.value);
            if (itemId && !isNaN(value) && value >= 0) {
                const key = formatDateKey(new Date());
                const schedule = state.studyData[key] || [];
                const item = schedule.find(s => s.id == itemId);
                if (item) {
                    if (item.type === 'break') {
                        item.durationHours = value / 60; 
                    } else {
                        item.durationHours = value;
                    }
                    if (item.type === 'subject') distributeSubTaskHours(item);
                    const itemIndex = schedule.indexOf(item);
                    recalculateStartTimes(itemIndex + 1);
                }
                closeModal(); render(); saveState();
            } else {
                DOM.hoursInput.classList.add('border-red-500');
                setTimeout(() => DOM.hoursInput.classList.remove('border-red-500'), 1500);
            }
        },
        toggleMainCompletion: (el) => { const item = state.studyData[formatDateKey(new Date())]?.find(s => s.id == el.dataset.itemId); if (item) { item.completed = !item.completed; if(item.type === 'subject') item.subTasks.forEach(t => t.completed = item.completed); render(); saveState(); } },
        toggleSubTaskPanel: (el) => { const subject = state.studyData[formatDateKey(new Date())]?.find(s => s.id == el.dataset.itemId); if(subject) { const n = subject.name; if (state.ui.openSubTaskPanels.has(n)) state.ui.openSubTaskPanels.delete(n); else state.ui.openSubTaskPanels.add(n); renderSubjects(); saveState();} },
        addSubTaskOnEnter: (el) => { const text = el.value.trim(); const s = state.studyData[formatDateKey(new Date())]?.find(s => s.id == el.dataset.itemId); if (s && text) { s.subTasks.push({ text, completed: false, status: 'None', hours: 0 }); distributeSubTaskHours(s); el.value = ''; render(); saveState(); } },
        toggleSubTaskCompletion: (el) => { const { itemId, taskIndex } = el.dataset; const s = state.studyData[formatDateKey(new Date())]?.find(s => s.id == itemId); if (s && s.subTasks[taskIndex]) { s.subTasks[taskIndex].completed = !s.subTasks[taskIndex].completed; render(); saveState(); } },
        deleteSubTask: (el) => { const { itemId, taskIndex } = el.dataset; const s = state.studyData[formatDateKey(new Date())]?.find(s => s.id == itemId); if (s) { s.subTasks.splice(taskIndex, 1); distributeSubTaskHours(s); render(); saveState(); } },
        cycleSubTaskStatus: (el) => { const { itemId, taskIndex } = el.dataset; const t = state.studyData[formatDateKey(new Date())]?.find(s => s.id == itemId)?.subTasks[taskIndex]; if(t){ const cur = ACTIVITY_TYPES.indexOf(t.status || 'None'); t.status = ACTIVITY_TYPES[(cur + 1) % ACTIVITY_TYPES.length]; render(); saveState(); } },
        confirmEndTime: () => { state.settings.sessionEndTime = DOM.sessionEndTimeInput.value; closeModal(); render(); saveState(); },
        resetApp: () => { if (confirm("Are you sure? This will delete all subjects and schedules.")) { localStorage.removeItem('studyPlannerState'); window.location.reload(); } },
        handleOptionSelection: (el) => {
            const { settingKey } = el.dataset; const value = el.dataset[Object.keys(el.dataset).find(k => k !== 'action' && k !== 'settingKey')]; const isNumeric = settingKey !== 'startTime';
            state.scheduleParams[settingKey] = isNumeric ? parseFloat(value) : value;
            const container = el.parentElement; container.querySelectorAll('.option-item').forEach(child => child.classList.remove('selected')); el.classList.add('selected');
            DOM.confirmGenerateBtn.disabled = !(state.scheduleParams.startTime && state.scheduleParams.subjectCount && state.scheduleParams.defaultDuration);
        },
        confirmGenerateSchedule: () => {
            const { startTime, subjectCount, defaultDuration } = state.scheduleParams; if (!startTime || !subjectCount || !defaultDuration) return;
            const shuffled = [...state.masterSubjects].sort(() => 0.5 - Math.random()); const randomSubjects = shuffled.slice(0, subjectCount);
            const [hour, minute] = startTime.split(':'); const scheduleStartTime = new Date(); scheduleStartTime.setHours(parseInt(hour), parseInt(minute), 0, 0);
            const newSchedule = randomSubjects.map(name => ({ id: Date.now() + Math.random(), type: 'subject', name: name, durationHours: defaultDuration, completed: false, subTasks: [], startTime: null }));
            if(newSchedule.length > 0) newSchedule[0].startTime = scheduleStartTime;
            state.studyData[formatDateKey(new Date())] = newSchedule; recalculateStartTimes(1);
            closeModal(); render(); saveState();
        },
        addBreak: () => {
            const key = formatDateKey(new Date()); const schedule = state.studyData[key] || []; if (schedule.length === 0) { alert("Generate a schedule first!"); return; }
            let insertionIndex = schedule.findIndex(item => !item.completed); if (insertionIndex === -1) insertionIndex = schedule.length;
            const newBreak = { id: Date.now() + Math.random(), type: 'break', durationHours: 15 / 60, completed: false, startTime: null };
            schedule.splice(insertionIndex, 0, newBreak); recalculateStartTimes(insertionIndex);
            render(); saveState();
        },
        deleteItem: (el) => {
            const key = formatDateKey(new Date()); const schedule = state.studyData[key] || []; const itemIndex = schedule.findIndex(i => i.id == el.dataset.itemId);
            if (itemIndex > -1) { schedule.splice(itemIndex, 1); recalculateStartTimes(itemIndex); render(); saveState(); }
        },
    };

    document.body.addEventListener('click', (e) => { const t = e.target.closest('[data-action]'); if (t && actions[t.dataset.action]) actions[t.dataset.action](t); });
    document.body.addEventListener('keydown', (e) => { const t = e.target.closest('[data-action-on-enter]'); if (t && e.key === 'Enter' && actions[t.dataset.actionOnEnter]) { e.preventDefault(); actions[t.dataset.actionOnEnter](t, e); } });
    
    document.body.addEventListener('dragstart', (e) => { const t = e.target.closest('[data-item-id]'); if (t) { state.ui.draggedItemId = t.dataset.itemId; e.dataTransfer.effectAllowed = 'move'; t.classList.add('dragging'); } });
    document.body.addEventListener('dragend', (e) => { const t = document.querySelector('.dragging'); if (t) t.classList.remove('dragging'); state.ui.draggedItemId = null; });
    document.body.addEventListener('dragover', (e) => { e.preventDefault(); const t = e.target.closest('[data-item-id]'); if (t && t.dataset.itemId !== state.ui.draggedItemId) { document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); t.classList.add('drag-over'); } });
    document.body.addEventListener('dragleave', (e) => { const t = e.target.closest('[data-item-id]'); if(t) t.classList.remove('drag-over'); });
    
    // MODIFICATION: Rewritten drop handler to reshuffle subjects into existing time slots.
    document.body.addEventListener('drop', (e) => {
        e.preventDefault();
        const t = e.target.closest('[data-item-id]');
        document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        if (t && state.ui.draggedItemId) {
            const schedule = state.studyData[formatDateKey(new Date())];
            const fromIndex = schedule.findIndex(s => s.id == state.ui.draggedItemId);
            const toIndex = schedule.findIndex(s => s.id == t.dataset.itemId);

            if (fromIndex > -1 && toIndex > -1 && fromIndex !== toIndex) {
                // 1. Create a snapshot of the time/duration slots BEFORE reordering.
                const timeSlots = schedule.map(item => ({
                    startTime: item.startTime,
                    durationHours: item.durationHours
                }));

                // 2. Reorder the array by moving the item object.
                const [draggedItem] = schedule.splice(fromIndex, 1);
                schedule.splice(toIndex, 0, draggedItem);

                // 3. Re-assign the times and durations from the snapshot to the newly ordered items.
                schedule.forEach((item, index) => {
                    item.startTime = timeSlots[index].startTime;
                    item.durationHours = timeSlots[index].durationHours;
                });

                render();
                saveState();
            }
        }
    });
    
    const createDragIcon = () => `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg>`;
    
    const init = () => { loadState(); render(); };
    init();
});
</script>
</body>
</html>
